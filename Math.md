# ðŸ§® The Math Behind F1 Strategy Control

> **"If we pit now, where will we finish?"**

This document explains the mathematical framework, physics proxies, and simulation algorithms powering the **F1 Strategy Control** engine. While the code (`app.py`, `train_model.py`) handles the execution, the logic relies on **Discrete Event Simulation** and **Non-Linear Regression**.

---

## 1. The Core Problem: Trajectory Optimization

Race strategy is effectively an optimization problem where the goal is to minimize the Total Race Time ($T_{race}$).

$$
\min T_{race} = \sum_{i=1}^{N} t_{lap}(i) + n_{stops} \cdot t_{pit\_loss}
$$

**Where:**
* $N$ is the total number of laps.
* $t_{lap}(i)$ is the time taken to complete lap $i$.
* $n_{stops}$ is the number of pit stops.
* $t_{pit\_loss}$ is the time lost driving through the pit lane (avg ~20-24s).

The challenge is that $t_{lap}$ is not constant; it is a dynamic function of the car's state that changes every second.

---

## 2. Modeling Lap Time (The "Brain")

We approximate the lap time function $f(x)$ using **Random Forest Regression**. Unlike linear models, Random Forest captures the non-linear "cliff" in tire performanceâ€”where grip falls off drastically after a specific age.

### The Function
$$
\hat{y}_{lap\_time} = f(Age_{tire}, Type_{compound}, N_{lap} \mid Track_{physics})
$$

### The State Vector ($x$)
The model accepts a state vector $x$ at every lap $i$:

1.  **Tire Age ($a$):** The number of laps driven on the current set.
    * *Math:* Degradation is modeled as a non-linear curve ($Performance \propto e^{-ka}$).
2.  **Compound ($c$):** Categorical variable (Soft, Medium, Hard).
    * *Encoding:* The distinct physical properties of rubber mixtures are encoded numerically (Soft=0, Medium=1, Hard=2).
3.  **Fuel Load Proxy ($N_{lap}$):**
    * *Physics:* Mass affects acceleration ($F=ma$). As the race progresses, mass ($m$) decreases linearly as fuel is burned.
    * *Proxy:* Since specific fuel flow data is encrypted, we use `LapNumber` as a linear proxy for mass reduction.

$$
Mass_{fuel} \approx Mass_{start} - (Rate_{burn} \cdot N_{lap})
$$

---

## 3. The Simulation Engine (The "Integrator")

To predict a race outcome (like the "Bearman Defense" scenario), we cannot just predict one lap. We must run a **Forward-Looking Discrete Simulation** (Numerical Integration).

### The Algorithm
For a remaining race distance of $R$ laps, we iteratively update the state of the **Chaser** ($C$) and the **Leader** ($L$).

**Initialization:**
$$Gap_0 = \text{Current Telemetry Gap (s)}$$

**Loop (for $k = 0$ to $R$):**

**1. Predict Pace:**
Calculate the predicted lap time for both drivers based on their future tire age and fuel load.

$$
\hat{t}_{C, k} = \text{Model}(Age_{C}+k, Cmp_{C}, Lap_{current}+k)
$$
$$
\hat{t}_{L, k} = \text{Model}(Age_{L}+k, Cmp_{L}, Lap_{current}+k)
$$

**2. Calculate Delta:**
Determine the time difference for that specific lap.

$$
\delta_k = \hat{t}_{L, k} - \hat{t}_{C, k}
$$
*(If $\delta_k > 0$, the Chaser is faster).*

**3. Update Gap:**
Subtract the delta from the current gap.

$$
Gap_{k+1} = Gap_k - \delta_k
$$

**4. Overtake Condition:**
If $Gap_{k+1} \le 0$, an overtake is successful at Lap $k$.

### Visualizing the Integral
The "Gap to Leader" graph generated by the app is effectively the integral of the pace difference over time:

$$
Gap(t) = Gap_{initial} - \int_{0}^{t} (Pace_{Leader} - Pace_{Chaser}) \, dt
$$

*(Approximated via discrete summation in `app.py`).*

---

## 4. Why Random Forest? (The "Cliff" Math)

Formula 1 tires do not degrade linearly. They obey a "Cliff" function where performance is stable for a while, then drops rapidly.

* **Linear Regression:** $y = mx + b$ (Fails to predict the sudden drop in grip).
* **Random Forest:** Segments the feature space into regions.
    * *Region A (Fresh):* Low Degradation.
    * *Region B (Worn):* High Degradation.
    * *Region C (Cliff):* Extreme Degradation.

By averaging $N$ decision trees, the model smoothes these steps into a continuous curve that closely matches the real physics of tire wear ($R^2 > 0.90$ on test sets).

---

## 5. Strategy Optimization Logic

The "Pit Wall" interface evaluates two parallel simulations to make a decision.

**Scenario A (Stay Out):**
The driver continues on current tires.

$$
T_{finish}^{stay} = \sum_{k=0}^{R} \text{Model}(Age_{current}+k, \dots)
$$

**Scenario B (Pit Now):**
The driver takes a pit stop ($t_{pit\_loss}$) and finishes on fresh tires ($Age=0$).

$$
T_{finish}^{pit} = T_{pit\_loss} + \sum_{k=0}^{R} \text{Model}(0+k, \text{NewCompound}, \dots)
$$

**Decision Rule:**

$$
\text{If } T_{finish}^{pit} < T_{finish}^{stay} \implies \textbf{BOX, BOX!}
$$

---
